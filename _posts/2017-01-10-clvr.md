---
layout: post
title: Clover Health - Treatment Outcomes Assignment
tags: []
---

## Contents
---

* [Exploring the Data](#exploring-the-data)
* [Assessment](#assessment)
* [Experiment Design](#experiment-design)


## Exploring the Data
---

I will be using R to analyze the pings data. The following packages are loaded :

* _lubridate_  : To parse the date time.
* _data.table_ : I prefer to use data.table over data.frame for performance efficiency.
* _ggplot2_    : To visualize data
* _dplyr_      : To perform data operations
* _rpart_      : To perform regression using decision trees
* _rpart.plot_ : To visualize the decision tree
~~~ r
> if (!require("pacman")) install.packages("pacman")
Loading required package: pacman
> pacman::p_load(data.table, ggplot2, dplyr, lubridate, rpart, rpart.plot)
~~~

I import the data and set up the columns to be factor and date columns appropriately. For the *outcome* column, I set 1 as success and 0 as failure.

~~~ r
> clvr_data <- read.csv("~/Projects/data-analysis/clvr/data")
> clvr_table <- data.table(clvr_data)
> clvr_table$servicing_provider_id <- as.factor(clvr_table$servicing_provider_id)
> clvr_table$member_id <- as.factor(clvr_table$member_id)
> clvr_table$member_sex <- as.factor(clvr_table$member_sex)
> clvr_table$treatment_date <- as.Date(parse_date_time(clvr_data$treatment_date, orders="mdy HM"))
> clvr_table$outcome <- ifelse(clvr_table$outcome == "failure", 0,1)
> clvr_table$outcome <- as.factor(clvr_table$outcome)
> summary(clvr_table)
    event_id    servicing_provider_id servicing_provider_name
 Min.   :   1   38     :  61          Toboggan   :  61
 1st Qu.:1076   67     :  60          Doom       :  60
 Median :2152   18     :  58          Constantine:  58
 Mean   :2153   68     :  57          Manhatten  :  57
 3rd Qu.:3228   39     :  56          Shephard   :  56
 Max.   :4300   94     :  55          Phil       :  55
                (Other):3900          (Other)    :3900
 treatment_date         member_id      member_age    member_sex
 Min.   :2015-01-01   1003   :   1   Min.   :64.00   0:2138
 1st Qu.:2015-04-04   1005   :   1   1st Qu.:66.00   1:2109
 Median :2015-07-05   1008   :   1   Median :68.00
 Mean   :2015-07-03   1013   :   1   Mean   :68.33
 3rd Qu.:2015-10-02   1015   :   1   3rd Qu.:71.00
 Max.   :2015-12-31   1020   :   1   Max.   :73.00
                      (Other):4241
 health_risk_assesment outcome
 Min.   : 1.000        0:2413
 1st Qu.: 3.000        1:1834
 Median : 5.000
 Mean   : 5.162
 3rd Qu.: 7.000
 Max.   :10.000
~~~

From the summary, we can see that we have information of the patient visits for the year 2015.
I verify that each row refers to a unique patient and also note that we have 96 physicians .

~~~ r
> nrow(clvr_table) == length(unique(clvr_table$member_id))
[1] TRUE
> length(unique(clvr_table$servicing_provider_id))
[1] 96
>
~~~

Plotting the histogram of Health Risk shows that the most of the users fall between the scores of 3 to 7 (inclusive).  The bars are broken down by the outcome of the treatment.

~~~ r
ggplot(clvr_table, aes(x=health_risk_assesment))
  + geom_bar(aes(fill = clvr_table$outcome), alpha=0.6)
  + labs(x = "Health Risk Assessment Scores", y = "Count")
  + scale_fill_manual(name="Outcome", labels = c("Failure", "Success"), values = c("red","green"))
  + ggtitle("Histogram of Health Risk Assessment Scores broken down by Outcome")
  + theme(plot.title = element_text(face = "bold"))
  + scale_x_discrete(limits = seq(from=1, to=10, 1))
~~~

![Histogram of Health Risk Assessment Scores](/data-analysis/assets/clvr-histogram-risk-scores.png)

Not surprisingly, the chart shows that higher the scores, higher the chances of failure. For a person with a score of 10, the chances are very slim for a successful treament.

I now plot the Risk Scores against the Date of Treatment colored by the sex of the patient. I wanted to see if there is any pattern with respect to time periods.

~~~ r
ggplot(clvr_table, aes(x=treatment_date, y = health_risk_assesment))
  + geom_point(aes(color=member_sex))
  + labs(x = "Date of Treatment", y ="Health Risk Assessment Score")
  + ggtitle("Health Risk Assessment vs Date")
  + theme(plot.title = element_text(face = "bold"))
  + scale_colour_discrete(name="Sex", labels=c("Female", "Male"))
~~~

clvd-risk-vs-date
![Histogram of Health Risk Assessment Scores](/data-analysis/assets/clvd-risk-vs-date.png)

There is no discernable pattern with respect to time. But I notice that patients with high risk scores (7-10) are more likely to be males than females.

~~~ r
> success_rate_by_sex <- clvr_table %>% group_by(member_sex) %>% summarise(success_rate = sum(outcome==1)/n(), num_of_cases = n(), avg_risk_score = mean(health_risk_assesment))
> success_rate_by_sex
# A tibble: 2 × 4
  member_sex success_rate num_of_cases avg_risk_score
      <fctr>        <dbl>        <int>          <dbl>
1          0    0.4798877         2138       4.675398
2          1    0.3831200         2109       5.656235
~~~

So, females have a successful treatment rate of about 48% whereas it is only 38% for males. Their average risk score is also lesser compared to males.



## Assessment
---

### a) If you were to only consider the provider’s efectiveness with regard to this particular treatment, would you recommend reaching out to any of these doctors in particular? If so, which ones, and why?

To evaluate the doctor/physician's performance, I first collect the information about their average success rate. Since the risk score and sex are possibly factors that affect the success rate, I also include the avergage risk assessment scores of the patients and the percentage of female
patients.

~~~ r
> doc_success_rate <- clvr_table %>% group_by(servicing_provider_id) %>% summarise(success_rate = sum(outcome==1)/n(), num_of_cases = n(), avg_risk_assessment = (mean(health_risk_assesment)), percentage_of_females_administered = round(100 * (sum(member_sex==0) / n())))  %>%  arrange(avg_risk_assessment)
> doc_success_rate
# A tibble: 96 × 5
   servicing_provider_id success_rate num_of_cases avg_risk_assessment percentage_of_females_administered
                  <fctr>        <dbl>        <int>               <dbl>                              <dbl>
1                     65    0.6279070           43            4.418605                                 37
2                     60    0.4651163           43            4.441860                                 58
3                     79    0.5957447           47            4.553191                                 43
4                     84    0.5744681           47            4.553191                                 53
5                     10    0.3939394           33            4.606061                                 39
6                     34    0.4545455           44            4.613636                                 66
7                     90    0.4528302           53            4.641509                                 42
8                     24    0.5000000           42            4.642857                                 50
9                     86    0.4333333           30            4.700000                                 70
10                    96    0.5098039           51            4.745098                                 57
# ... with 86 more rows
~~~

Here is a plot of the information gathered above:

~~~ r
ggplot(doc_success_rate, aes(x= success_rate, y = avg_risk_assessment))
  + geom_point(aes(size=num_of_cases, color=percentage_of_females_administered))
  + labs(x = "Success Rate", y = "Average Risk Assessment Score")
  + scale_colour_continuous(name="% of Females Administered")
  + scale_size(name="Number of Cases")
  + ggtitle("Average Risk Assessment Score against Success Rate For Physicians")
  + theme(plot.title = element_text(face = "bold"))
~~~

![Risk Scores vs Success Rate](/data-analysis/assets/clvr-score-vs-success.png)

There are some physicians who have a high success rate even if they have mostly worked with males (plotted on the extreme right with darker shades of blue). We definitely want to recommend these physicians.

The physicians in the middle of the plot show a mix of different percentage levels of female patients and average risk scores.



~~~ r
clvr.tree.model <- rpart(clvr_table$outcome~., data = clvr_table[,c(2,6,7,8),with=FALSE])
prp(clvr.tree.model)
split.fun <- function(x, labs, digits, varlen, faclen)
{
# replace commas with spaces (needed for strwrap)
labs <- gsub(",", " ", labs)
for(i in 1:length(labs)) {
# split labs[i] into multiple lines
labs[i] <- paste(strwrap(labs[i], width=25), collapse="\n")
}
prp(clvr.tree.model, split.fun = split.fun)
~~~

b) What other data would be helpful in understanding which doctors to reach out to? What other data would help you evaluate the overall clinical e ectiveness of the doctor? How would you use this data?
-  more data for verifying sex
- health_risk_assesment is combination of different factors, so it would be useful to break it down on the various factors
  that affect the dieases/risk assessment and then use the tree split.
 because of correlated varibales/ confounding



## Experiment Design
___
A product manager wants to make a change to a piece of software that all of the physicians al- ready possess. The change will notify the physician whenever a prescription is about to run out. How would you set up this change to know whether it had an e ect? What metrics would you use to evaluate the change? What are some of the challenges of measurement with this type of change?

- A/B testing
- feature to indicate if physician overran or not.
- order history
- clicked order from reminder
- if they don't click button and order from phone instead then we wouldn't know.

